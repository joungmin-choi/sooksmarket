<!DOCTYPE html>
<html>
<head>
  <% include ./sm_head %>

  <style>
  .thumbnail button{
    margin: 2%;
  }
  .filebox label {
    margin:-1%;
   }
 .filebox input[type="file"] { /* 파일 필드 숨기기 */
    position: absolute;
    clip:rect(0,0,0,0);
 }
  </style>

  <script>
  var flag = 0; // 하나도 업로드를 안하면 0, 그렇지 않으면 1
  var changeFile = new Array();  // 변경하면 1, 아니면 0
  var counter = <%= photo.length %>;
  var add = 0;
  var photoState = new Array();

  window.onload = function(){
    <% for(var i=0; i<3; i++){ %>
      photoState[i] = <%= photoState[i] %>;
    <% } %>
  }



  function submitCheck(){
    var target = document.getElementById("target");
    var price = document.getElementById("price");
    var form = document.getElementById("form");
    var way = document.getElementsByName("way");

    if(target.value==""){
      alert("상품명을 입력하세요.");
      return false;
    }
    else if(price.value==""){
      alert("가격을 입력하세요.");
      return false;
    }
    else if(form.category.value==""){
      alert("품목을 선택하세요.");
      return false;
    }
    else if((way[0].checked == false) && (way[1].checked == false)){
      alert("거래방법을 선택하세요.");
      return false;
    }
    else{
      for(i=0; i< 3; i++){
        var hidden = document.getElementById("hidden"+i);
        hidden.value = changeFile[i];
      }

      form.submit();
      return true;

    }

  }

  $(document).ready(function(){
    $("#category").val("<%= `${category}` %>").attr("selected", "selected");


    for(i=0; i< 3; i++){
      changeFile[i] = 0;
    }
  });



  function previewFiles(i) {

    var preview = document.querySelector('#preview'+i);
    var files   = document.querySelector('#file'+i).files;

    function readAndPreview(file) {

      // `file.name` 형태의 확장자 규칙에 주의하세요
      if ( /\.(jpe?g|png|gif)$/i.test(file.name) ) {
        var reader = new FileReader();

        reader.addEventListener("load", function () {
          var imgId="img" + i;
          var imgObject = document.getElementById(imgId);

          var image = new Image();
          image.className = "img-responsive img-center img-thumbnail img";
          image.id = imgId;
          image.height = 100;
          image.title = file.name;
          image.src = this.result;
          image.style = "height:180px; width: 300px; margin-top:2%";

          preview.removeChild( imgObject );
          preview.appendChild( image );

          changeFile[i] = 1;

        }, false);

        reader.readAsDataURL(file);
      }

    }

    if (files) {
      [].forEach.call(files, readAndPreview);
    }

  };

  var deleteThum = function(i) {
    var thum = document.getElementById("div"+i);

    // var thum = document.getElementById("div"+i);
    // while (thum.firstChild) {
    //   thum.removeChild(thum.firstChild);
    // }
    // counter--;

  };

function countNum(){
  if (counter >= 3){
    alert("최대 3개의 이미지를 추가하실 수 있습니다.");
    event.stopPropagation();
    event.returnValue = false;
  }
}

  function addImg() {

      var preview = document.querySelector('#preview'+counter);
      var files   = document.querySelector('#add').files;

      function readAndPreview(file) {
        var divId = document.getElementById("div"+counter);
        divId.style.display = 'block';

        // `file.name` 형태의 확장자 규칙에 주의하세요
        if ( /\.(jpe?g|png|gif)$/i.test(file.name) ) {
          var reader = new FileReader();

          reader.addEventListener("load", function () {
            var imgId="img" + counter;
            var imgObject = document.getElementById(imgId);

            var image = new Image();
            image.className = "img-responsive img-center img-thumbnail img";
            image.id = imgId;
            image.height = 100;
            image.title = file.name;
            image.src = this.result;
            image.style = "height:180px; width: 300px; margin-top:2%";

            preview.removeChild( imgObject );
            preview.appendChild( image );

            changeFile[counter]=1;
            photoState[counter] = 1;
            counter++;

          }, false);

          reader.readAsDataURL(file);
        }

      }

      if (files) {
        [].forEach.call(files, readAndPreview);
      }
  };



  // function changeFile(i){
  //   var imgId="img" + i;
  //   var imgObject = document.getElementById(imgId);
  //   var img_src = $(imgObject).attr("src");
  //
  //   <input type="file" name="myfile"/>
  //   //$.post("/changeFile", {img_src: img_src});
  //
  //   //alert($(element).attr("src"));
  // }

  </script>


</head>

<body class="body">
    <% include ./sm_top_navigator %>

    <div class="container">
      <!--1-->
      <p class="lead"><strong>Shop Name</strong></p>
      <!--2-->
      <div class="row">
      <!-- (2-1) -->
      <div class="col-md-3">
        <% include ./sm_sidebar %>
      </div>
      <!-- (2-2) -->
      <div class="col-md-9">
        <form action='/sm_changeDetail/<%= id %>' class="form-horizontal" role="form" id="form" name="form" method = "post"  enctype="multipart/form-data" onsubmit="return submitCheck()" >
          <div class="form-group"> <!--has-success has-feedback-->
            <label for="" class="col-sm-3 control-label">팔고자 하는 물건 :</label>
            <div class="col-sm-5">
              <input type="text" class="form-control" name="name" id="target"  placeholder="내용을 입력해주세요." value="<%= name %>">

            </div>
          </div>
          <div class="form-group"> <!--has-success has-feedback-->
            <label for="" class="col-sm-3 control-label">가격 :</label>
            <div class="col-sm-5">
              <input type="text" id="price" class="form-control" name="price" placeholder="내용을 입력해주세요." value="<%= price %>">
            </div>
          </div>
          <div class="form-group"> <!--has-success has-feedback-->
            <label for="" class="col-sm-3 control-label">카테고리 :</label>
            <div class="col-sm-5">
              <select class="form-control" id="category" name="category" style="cursor:context-menu;" onclick="category()">
                <option value="옷">옷</option>
                <option value="화장품">화장품</option>
                <option value="책">책</option>
                <option value="전자기기">전자기기</option>
                <option value="음식">음식</option>
                <option value="필기류">필기류</option>
                <option value="티켓 양도">티켓 양도</option>
                <option value="기타">기타</option>
              </select>
            </div>
          </div>
          <div class="form-group"> <!--has-success has-feedback-->

            <div class="col-sm-3 control-label">
              <label for="" class="control-label">사진 :</label>
              <p>
                <button type="button" class="filebox btn btn-default btn-primary" onclick="countNum()">
                  <label for="add">+</label>
                  <input type="file" id="add" name="add" accept="image/*" capture="photo" onchange="addImg()">

                </button>
              </p>
            </div>

            <div class="col-sm-5 text-center">
              <div class="thumbnail">
                <% for (i=0; i< photo.length; i++){ %>
                  <div id="div<%= i %>">
                    <input type="hidden" name="hidden<%= i %>" id="hidden<%= i %>" value="" />

                    <div id="preview<%= i %>">
                      <img class="img-responsive img-center img-thumbnail img" name="img<%= i %>" id="img<%= i %>" src="<%= photo[i]%>" alt="x" style="height:180px; width: 300px; margin-top:2%"/>
                    </div>

                    <button type="button" class="filebox btn btn-default btn-warning">  <!-- onclick="changeFile(<%= i %>)" -->
                      <label for="file<%= i %>">변경</label>
                      <input type="file" id="file<%= i %>" name="file" accept="image/*" capture="photo" onchange="previewFiles(<%= i %>)"> <!-- onchange="change(<%= i %>, this)" -->
                    </button>

                    <button type="button" class="btn btn-default" onclick="deleteThum(<%= i %>)">삭제</button>
                  </div>

                  <!-- <button type="button" class="btn btn-default btn-warning" onclick="location.href='/sm_changeDetail/sm_changeFile">변경</button>
                  <button type="button" class="btn btn-default" onclick="location.href='/sm_changeDetail/sm_deleteFile">삭제</button> -->

                <% } %>
                <% for (i=photo.length; i< 3; i++){ %>
                  <div id="div<%= i %>" style="display:none;">
                    <input type="hidden" name="hidden<%= i %>" id="hidden<%= i %>" value="" />

                    <div id="preview<%= i %>">
                      <img class="img-responsive img-center img-thumbnail img" name="img<%= i %>" id="img<%= i %>" src="" alt="x" style="height:180px; width: 300px; margin-top:2%"/>
                    </div>

                    <button type="button" class="filebox btn btn-default btn-warning">  <!-- onclick="changeFile(<%= i %>)" -->
                      <label for="file<%= i %>">변경</label>
                      <input type="file" id="file<%= i %>" name="file" accept="image/*" capture="photo" onchange="previewFiles(<%= i %>)"> <!-- onchange="change(<%= i %>, this)" -->
                    </button>

                    <button type="button" class="btn btn-default" onclick="deleteThum(<%= i %>)">삭제</button>
                  </div>
                <% } %>

              </div>
            </div>



              <!-- <input type="file" id="file" class="form-control" name="file"  accept="image/*" capture="photo"  multiple="true" onChange="Upload(this)";> -->

          </div>
          <div class="form-group"> <!--has-success has-feedback-->
            <label for="" class="col-sm-3 control-label">희망거래방법 :</label>
            <div class="col-sm-5">
              <% if (way == 1){ %>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="직거래" checked>직거래</label>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="사물함거래">사물함거래</label>
              <% } else if (way == 2){ %>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="직거래">직거래</label>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="사물함거래" checked>사물함거래</label>
              <% } else { %>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="직거래" checked>직거래</label>
                <label class="checkbox-inline"><input name="way" type="checkbox" value="사물함거래" checked>사물함거래</label>
              <% }%>

            </div>
          </div>
          <div class="form-group"> <!--has-success has-feedback-->
            <label for="" class="col-sm-3 control-label">상세내용 :</label>
            <div class="col-sm-5">
              <textarea type="text" id="price" class="form-control" name="detail" rows="3"  placeholder="제품에 대한 설명을 해주세요" style="resize: none;"><%= detail %></textarea>
            </div>
          </div>
          <div class="form-group"> <!--has-success has-feedback-->
            <div class="text-center">
                <input type="submit" value="등록하기" class="btn btn-primary" onclick="location.href='/sm_changeDetail/<%= id %>'" >
                <input type="reset" value="취소하기" class="btn btn-danger" >
            </div>
          </div>

        </form>
      </div>
      </div>
    </div>

</body>


<% include ./sm_footer %>

</html>
